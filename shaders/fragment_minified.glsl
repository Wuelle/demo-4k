#version 330 core
uniform float v;const vec2 y=vec2(.866025,1);vec2 r;const vec3 s=vec3(-.866025404,.5,.577350269);const vec3 m=vec3(1);float n(vec2 v,float y,float a){float r=fract((length(v)-a)/y);return smoothstep(0,1,min(r,1.-r));}float n(vec2 y){return n(y,5.,v*3)*smoothstep(20.,27.,v);}float f(vec2 y){float r=mod(abs(atan(y.y,y.x)+v/2.),.785)/.785;r=min(r,1.-r);return min(3.*n(y,10.,3.)*smoothstep(0,1,r),1.)*smoothstep(34.,39.,v);}float p(vec2 v){return dot(sin(v*2.-cos(v.yx*1.4)),vec2(.17))+2.5+.2*n(v);}float e(vec2 v){v=abs(v);v-=2.*min(dot(s.xy,v),0.)*s.xy;v-=vec2(clamp(v.x,-s.z*.23,s.z*.23),.23);return length(v)*sign(v.y);}float e(vec2 v,float y,float r){float m=e(v);vec2 s=vec2(m,abs(vec3(v.x,y,v.y).y)-r);return min(max(s.x,s.y),0.)+length(max(s,0.));}float f(vec2 v,float y,vec2 r){return e(v,y,p(r))-.02;}vec3 e(vec2 v,float r){vec4 s=floor(vec4(v,v-vec2(0,.5))/y.xyxy)+vec4(0,0,0,.5),a=floor(vec4(v-vec2(.5,.25),v-vec2(.5,.75))/y.xyxy)+vec4(.5,.25,.5,.75),m=vec4(v-(s.xy+.5)*y,v-(s.zw+.5)*y),c=vec4(v-(a.xy+.5)*y,v-(a.zw+.5)*y),d=vec4(f(m.xy,r,s.xy),f(m.zw,r,s.zw),f(c.xy,r,a.xy),f(c.zw,r,a.zw));vec3 n=d.x<d.y?vec3(d.x,s):vec3(d.y,s.zw),x=d.z<d.w?vec3(d.z,a):vec3(d.w,a.zw);return n.x<x.x?n:x;}float a(vec3 v){vec3 s=e(v.xz,v.y);r=s.yz;return s.x;}vec3 a(){vec3 v=vec3(.8+sin(r.x*5)/5.,.2,.6+cos(r.y*5)/5.),y=mix(v,vec3(1,0,0),n(r));return mix(y,vec3(0,0,1),f(r));}vec3 t(vec3 v){const vec2 s=vec2(.0025,0);return normalize(vec3(a(v+s.xyy)-a(v-s.xyy),a(v+s.yxy)-a(v-s.yxy),a(v+s.yyx)-a(v-s.yyx)));}vec2 a(vec3 v,vec3 y,float r){float s=0.,f=1.,c=1e20;for(int m=0;m<200&&s<r-.1;m++){float d=a(v+s*y);if(d<.001)return vec2(s+d,.1);f=min(f,30.*d/s);c=d;s+=d;}return vec2(s,1);}void main(){vec2 s=vec2(1e3,600),r=(gl_FragCoord.xy-s.xy/2.)/s.y;vec3 y=vec3(3,10,3),d,f;f=v<15?(d=vec3(5.+v,8,5),d+vec3(1.+sin(v/3.),-1.5,2)):v<40?(d=vec3(5,v-6.,5),vec3(0)):v<65?(d=vec3(5,2.*40-v-6.,5),vec3(v-40,v-40,0)):(d=vec3(5,9,5),vec3(25,25,0));float c=0.;if(v>67)c=3.14*smoothstep(67.,72.,v);mat2 n=mat2(cos(c),-sin(c),sin(c),cos(c));r=n*r;vec3 x=normalize(f-d),w=normalize(vec3(x.z,0,-x.x)),i=normalize(x+1.256636*r.x*w+1.256636*r.y*cross(x,w));i.y=-abs(i.y);float l=a(d,i,60.).x;vec3 e=d+l*i;if(l<60.){vec3 z=t(e);float p=dot(z,-i);vec3 g=a(),C=e-y;vec2 F=a(y,normalize(C),length(C));vec3 E=p*g;E+=pow(dot(z,-normalize(y-e)),8.)/8.*m;E*=exp(-1.5e-5*l*l*l);gl_FragColor=vec4(E*F.y,1);}else gl_FragColor=vec4(0,0,0,1);}